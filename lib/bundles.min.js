const path=require("path"),fs=require("fs-extra"),globby=require("globby"),matter=require("gray-matter");function compile(e="",n={}){return resolveConfig(e,n).then(runBundles).then(createWatchers).then(prepResults).catch(throwError)}function resolveConfig(e="",n={}){return new Promise((r,t)=>{let s=!1;if("string"==typeof e){const r=require("cosmiconfig")("bundles");if(e){if(!fs.pathExistsSync(e))return t(new Error("Config file was not found."));e=e.split(":"),n.bundles=n.bundles||e[1]||void 0,"all"!==n.bundles&&"string"==typeof n.bundles&&(n.bundles=n.bundles.split(/,?\s+/)),e=e[0],e=r.loadSync(e)}else e=r.searchSync(e);if(!e)return t(new Error("Config file was not found."));s=e.filepath,e=e.config}return e.input&&e.bundlers&&(e={bundles:[e]}),(e=Object.assign({success:!1,bundles:[],bundlesMap:{},options:{},watchers:{},on:{}},e,{options:n,_meta:{configFile:s,createdWatchers:!1}})).bundles=normalizeBundles(e.bundles,e.options),r(e)})}function runBundles(e={}){const n=[];return e.bundles.forEach((r,t)=>{!r._meta.isValid||e.options.bundles&&!e.options.bundles.includes(r.id)?(r.success="skipped",n.push(r)):n.push(runBundle(r))}),Promise.all(n).then(n=>(e.bundles=n,e))}function createWatchers(e={}){if(e._meta.createdWatchers)return e;if(e._meta.createdWatchers=!0,"string"==typeof e.options.watch&&(e.options.watch=e.options.watch.split(/,?\s+/)),!1===e.options.watch)return e;e.options.watch instanceof Array||(e.options.watch=Boolean(e.options.watch));const n=require("chokidar"),r=[];return e.bundles.forEach((t,s)=>{(t.watch||e.options.watch&&!(e.options.watch instanceof Array&&e.options.watch.includes(t.id))||e.watchers[t.id])&&r.push(new Promise((r,s)=>{const o=n.watch(t.output.map(e=>e.source.path),"object"==typeof t.watch?t.watch:{});o.on("change",n=>{if(t._meta.isWatching)return compile(e,{rebundle:t.id}).then(r=>{let s=r.bundlesMap[t.id];return"function"==typeof e.on.afterChange&&(s=e.on.afterChange(s,{filepath:n,config:e})),"function"==typeof s.on.afterChange&&(s=s.on.afterChange(s,{filepath:n,config:e})),r})}).on("error",s).on("ready",()=>{t._meta.isWatching=!0,r()}),o.id=t.id,e.watchers[t.id]=o}))}),Promise.all(r).then(()=>e)}function prepResults(e={}){return e.success=!e.bundles.some(e=>!e._meta.isValid||!e.success),e.bundlesMap={},e.bundles.forEach((n,r)=>{e.bundlesMap[n.id]=e.bundles[r]}),e.errors=e.bundles.reduce((e,n,r)=>e.concat(n.errors),[]),e.debug&&e.errors.length&&(console.log(e.errors.length>1?`There were ${e.errors.length} errors...`:"There was an error..."),e.errors.forEach(e=>console.error(e))),e}function runBundle(e={}){return e.bundlers.reduce((n,r,t)=>n.then(e=>{const n=r.run(e,r);return r.success=!0,n}).catch(n=>(r.success=!1,e.errors.push(n),e)),Promise.resolve(e)).then(e=>(e.success=e.bundlers.every(e=>e.success),e)).catch(n=>(e.success=!1,e.errors.push(n),e))}function normalizeBundles(e=[],n={}){return e instanceof Object&&e.constructor===Object&&(e=[e]),e instanceof Array||throwError("`config.bundles` must be an Array."),e.map((e,r)=>{if(!n.rebundle||e.id===n.rebundle)return normalizeBundle(e,n,r)})}function normalizeBundle(e={},n={},r){return e instanceof Object||(e={_meta:{isValid:!1}}),"string"==typeof(e=Object.assign({errors:[],id:String(r),input:[],output:[],bundlers:[],watch:Boolean(n.watch||e.watch),on:{},_meta:{}},e)).input&&(e.input=e.input.split(/,?\s+/)),e.input instanceof Array||(e.input=[e.input]),e.input.forEach((n,r)=>{if(0===n.indexOf("gh:")&&(n=`https://github.com/${n.slice(3)}.git`),0===n.indexOf("http://")||0===n.indexOf("https://")||0===n.indexOf("git@")){const t=path.join(".repos",path.basename(n).replace(".git","")),s=require("child_process").execSync;fs.ensureDirSync(".repos"),fs.removeSync(t),s(`git clone ${n} ${t}`),e.input[r]=t}}),e.input=globby.sync(e.input,Object.assign({dot:!0},n.glob||{})),e.input.forEach((r,t)=>{e.output[t]=readFile(r,n.frontMatter||{})}),"string"==typeof e.bundlers&&(e.bundlers=e.bundlers.split(/,?\s+/)),e.bundlers=e.bundlers.map(n=>resolveBundler(n,e)),e._meta.isValid=isValidBundle(e),e}function readFile(e,n={}){const r={};return r.source=matter.read(e,n),r.source.path=path.normalize(e),r.content=r.source.content,0===r.content.indexOf("\n")&&(r.content=r.content.slice(1)),r.data=r.source.data,r}function resolveBundler(e,n){if(e instanceof Object&&e.constructor===Object||(e={run:e}),e._meta=e._meta||{},e._meta.isValid=!0,e.success=!1,"function"==typeof e.run)return e;if(!e.run||"string"!=typeof e.run)return e._meta.isValid=!1,e;if(0!==e.run.indexOf("./")&&0!==e.run.indexOf("../")||(e.run=path.resolve(e.run)),-1===path.basename(e.run).indexOf("bundles-")){const n=path.join(path.dirname(e.run),"bundles-"+path.basename(e.run));try{require.resolve(n)&&(e.run=n)}catch(e){}}try{e.run=require(e.run)}catch(r){return e._meta.isValid=!1,n.errors.push(r),e}return"function"!=typeof e.run&&(e._meta.isValid=!1),e}function isValidBundle(e={}){return e instanceof Object&&e.input instanceof Array&&e.input.every(e=>"string"==typeof e)&&e.bundlers instanceof Array&&e.bundlers.length&&e.bundlers.some(e=>e._meta.isValid)}function throwError(e="Uh oh..."){throw new Error(e)}module.exports=compile;